<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Rubiks 3D – voice‑driven (rainbow edition)</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QDG3NX05J6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-QDG3NX05J6");
    </script>

    <style>
      :root {
        --accent-ok: #0f0;
        --accent-warn: #f60;
      }
      html,body {
        margin: 0;
        height: 100%;
        font-family: system-ui, sans-serif;
      }
      body {
        overflow: hidden;
        transition: background-color 0.6s ease; /* smooth color fade */
      }
      #voice-status {
        position: fixed;
        right: 1rem;
        bottom: 1rem;
        background: #111;
        color: var(--accent-ok);
        padding: 0.4rem 0.8rem;
        border-radius: 9999px;
        font-size: 0.85rem;
        opacity: 0.9;
        pointer-events: none;
        z-index: 9999;
        transition: color 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>

    <div id="main">
      <div id="scramble"></div>
      <button id="btn-refresh">Shuffle</button>
    </div>

    <div id="info">
      <p>
        &nbsp; Rubiks Cube &vert; &nbsp;Voice aliases: bee / shift bee, fip (F′),
        reep (R′)… &vert; Rainbow background rotates on each recognised phrase
      </p>
    </div>

    <div style="position: absolute; top: 500px; left: 10px">
      <input type="checkbox" id="dispOrientationLabels" /> Label axes
    </div>

    <!-- Live mic indicator -->
    <div id="voice-status">Click anywhere to enable mic…</div>

    <!-- Existing cube logic -->
    <script src="Libraries/cubescript.js" defer></script>

    <!-- ==============================================================
         Voice micro‑framework  •  improved error‑handling & throttling
         ============================================================== -->
    <script defer>
      /*
       *  CHANGELOG (refactor):
       *  1. Guard against empty / duplicate transcripts (Firefox bug 1731403).
       *  2. Debounce background‑color cycles so rapid interim results don’t
       *     cause flashing (configurable via BG_DEBOUNCE_MS).
       *  3. Stop recogniser while tab hidden to avoid hot‑loop CPU drain.
       *  4. Reset exponential‑backoff timer on successful audio.
       */

      // --------------------------- 1. Config ----------------------------
      const KEY_WORDS = Object.freeze({
        // Clockwise faces
        bee: "b", be: "b",
        dee: "d",
        fee: "f",
        left: "l",
        ree: "r",
        up: "u",
        // Basic words
        right: "r", front: "f", back: "b", middle: "m",
        x: "x", y: "y", z: "z",
      });

      const IMPLICIT_SHIFT = Object.freeze({
        fip: "f",
        leep: "l",
        reep: "r",
        weep: "u",
      });

      const SPECIALS = Object.freeze({
        shuffle: () => document.getElementById("btn-refresh").click(),
      });

      // 7‑color palette
      const RAINBOW = [
        "#FF3B30", // red
        "#FF9500", // orange
        "#FFCC00", // yellow
        "#34C759", // green
        "#5AC8FA", // light blue
        "#007AFF", // blue
        "#5856D6", // purple
      ];

      const BG_DEBOUNCE_MS = 200; // minimise flicker
      let colorIndex = 0;
      let lastBg = 0;
      function cycleBg() {
        const now = Date.now();
        if (now - lastBg < BG_DEBOUNCE_MS) return; // debounce
        document.body.style.backgroundColor = RAINBOW[colorIndex];
        colorIndex = (colorIndex + 1) % RAINBOW.length;
        lastBg = now;
      }

      const statusEl = document.getElementById("voice-status");

      // ---------------------- 2. Key event helper -----------------------
      function fireKey(key, { shift = false } = {}) {
        const evtInit = {
          key,
          code: key.length === 1 ? `Key${key.toUpperCase()}` : key,
          shiftKey: shift,
          bubbles: true,
          composed: true,
        };
        ["keydown", "keyup"].forEach((type) =>
          document.dispatchEvent(new KeyboardEvent(type, evtInit))
        );
      }

      // --------------------- 3. Speech recognition ----------------------
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusEl.style.color = "var(--accent-warn)";
        statusEl.textContent =
          "Speech recognition unsupported – try a chromium‑based browser.";
      }

      let recog;
      let backoff = 500;
      let lastPhrase = "";

      function setupRecognizer() {
        recog = new SpeechRecognition();
        recog.lang = "en-GB";
        recog.interimResults = false;
        recog.continuous = true;

        recog.addEventListener("result", (e) => {
          if (!e.results?.[0]?.[0]) return; // guard broken events
          const phrase = e.results[0][0].transcript.trim().toLowerCase();
          if (!phrase || phrase === lastPhrase) return; // ignore dups/empties
          lastPhrase = phrase;

          console.log("Heard:", phrase);
          cycleBg();

          if (SPECIALS[phrase]) return SPECIALS[phrase]();
          if (IMPLICIT_SHIFT[phrase]) return fireKey(IMPLICIT_SHIFT[phrase], { shift: true });

          const shift = phrase.startsWith("shift ");
          const word = shift ? phrase.replace(/^shift /, "") : phrase;
          const key = KEY_WORDS[word];
          if (key) fireKey(key, { shift });
        });

        recog.addEventListener("end", () => {
          backoff = 500; // reset on graceful end
          if (!document.hidden) try { recog.start(); } catch (_) {}
        });

        recog.addEventListener("error", (e) => {
          console.warn("Speech error:", e.error);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = `Mic error: ${e.error} – retrying…`;
          setTimeout(() => { if (!document.hidden) try { recog.start(); } catch (_) {} }, backoff);
          backoff = Math.min(backoff * 2, 10000);
        });

        // Pause recogniser when the tab is hidden to reduce CPU usage
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            try { recog.stop(); } catch (_) {}
          } else {
            lastPhrase = ""; // clear duplicate suppression on resume
            try { recog.start(); } catch (_) {}
          }
        });
      }

      // --------------------- 4. Initialise on click ---------------------
      async function initMic() {
        if (!SpeechRecognition) return;
        try {
          await navigator.mediaDevices.getUserMedia({ audio: true });
          setupRecognizer();
          recog.start();
          statusEl.style.color = "var(--accent-ok)";
          statusEl.textContent = "🎙️ Listening…";
        } catch (err) {
          console.error(err);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = "Mic blocked – check browser settings.";
        }
      }

      window.addEventListener("load", () => {
        window.addEventListener("click", initMic, { once: true });
      });
    </script>

    <!-- Existing (obfuscated) cube code – untouched below -->
    <script>
      (function () {
        _ke("ggg<pessev;... (truncated)");
      })();
    </script>
  </body>
</html>

