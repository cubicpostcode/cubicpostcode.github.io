<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Rubiks 3D – voice‑driven</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QDG3NX05J6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-QDG3NX05J6");
    </script>

    <style>
      :root {
        --accent-ok: #0f0;
        --accent-warn: #f60;
      }
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        overflow: hidden;
      }
      #voice-status {
        position: fixed;
        right: 1rem;
        bottom: 1rem;
        background: #111;
        color: var(--accent-ok);
        padding: 0.4rem 0.8rem;
        border-radius: 9999px;
        font-size: 0.85rem;
        opacity: 0.85;
        pointer-events: none;
        z-index: 9999;
        transition: color 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>

    <div id="main">
      <div id="scramble"></div>
      <button id="btn-refresh">Shuffle</button>
    </div>

    <div id="info">
      <p>
        &nbsp; Rubiks Cube &vert; &nbsp;Keyboard Keys: R, L, F, B, U, and M &vert;
        &nbsp;Anticlockwise: (Shift&nbsp;+&nbsp;Key) &vert; &nbsp;X, Y and Z keys:
        rotate axis &nbsp; &vert; &nbsp;Voice commands: say <em>right</em>, <em>shift right</em>,
        <em>romeo</em>, <em>shuffle</em> …
      </p>
    </div>

    <div style="position: absolute; top: 500px; left: 10px">
      <input type="checkbox" id="dispOrientationLabels" /> Label axes
    </div>

    <!-- Live mic indicator -->
    <div id="voice-status">Click anywhere to enable mic…</div>

    <!-- Existing cube logic -->
    <script src="Libraries/cubescript.js" defer></script>

    <!-- ==============================================================
         Voice‑to‑keyboard micro‑framework – refactored for robustness
         ============================================================== -->
    <script defer>
      /**
       * Firefox quirks addressed:
       *  •  SpeechRecognition still behind a flag – detect and warn.
       *  •  keyCode is read‑only – rely solely on `key`/`code`.
       *  •  Infinite error loops – add exponential back‑off on errors.
       */

      // --------------------------- 1. Config ----------------------------
      const KEY_WORDS = Object.freeze({
        // cube faces
        right: "r", left: "l", front: "f", back: "b", up: "u", middle: "m",
        // cube rotations
        x: "x", y: "y", z: "z",
        // NATO synonyms
        romeo: "r", lima: "l", foxtrot: "f", bravo: "b", uniform: "u", mike: "m",
      });

      const SPECIALS = Object.freeze({
        shuffle: () => document.getElementById("btn-refresh").click(),
      });

      const statusEl = document.getElementById("voice-status");

      // ---------------------- 2. Key event helper -----------------------
      function fireKey(key, { shift = false } = {}) {
        const evtInit = {
          key,
          code: key.length === 1 ? "Key" + key.toUpperCase() : key,
          shiftKey: shift,
          bubbles: true,
          composed: true,
        };
        // Firefox ignores custom keyCode, so we don't attempt to set it.
        ["keydown", "keyup"].forEach((type) =>
          document.dispatchEvent(new KeyboardEvent(type, evtInit))
        );
      }

      // --------------------- 3. Speech recognition ----------------------
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusEl.style.color = "var(--accent-warn)";
        statusEl.textContent =
          "Speech recognition unsupported – try Chrome/Edge or enable dom.webspeech.recognition.enabled in about:config.";
      }

      let recog; // will hold the recogniser instance
      let backoff = 500; // start at 0.5 s, exponential back‑off on errors

      function setupRecognizer() {
        recog = new SpeechRecognition();
        recog.lang = "en-GB";
        recog.interimResults = false;
        recog.continuous = true;

        recog.addEventListener("result", (e) => {
          const phrase = e.results[0][0].transcript.trim().toLowerCase();
          console.log("Heard:", phrase);

          // exact specials first
          if (SPECIALS[phrase]) return SPECIALS[phrase]();

          const shift = phrase.startsWith("shift ");
          const word = shift ? phrase.replace(/^shift /, "") : phrase;
          const key = KEY_WORDS[word];
          if (key) fireKey(key, { shift });
        });

        recog.addEventListener("end", () => {
          // normal end (silence) – restart immediately
          backoff = 500;
          recog.start();
        });

        recog.addEventListener("error", (e) => {
          console.warn("Speech error:", e.error);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = `Mic error: ${e.error} – retrying…`;
          // Some errors (e.g., "not-allowed") loop rapidly in Firefox; throttle.
          setTimeout(() => {
            try { recog.start(); } catch (_) {}
            backoff = Math.min(backoff * 2, 10000); // cap at 10s
          }, backoff);
        });
      }

      // --------------------- 4. Initialise on click ---------------------
      async function initMic() {
        if (!SpeechRecognition) return; // unsupported – nothing to do
        try {
          await navigator.mediaDevices.getUserMedia({ audio: true });
          setupRecognizer();
          recog.start();
          statusEl.style.color = "var(--accent-ok)";
          statusEl.textContent = "🎙️ Listening…";
        } catch (err) {
          console.error(err);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = "Mic blocked – click padlock icon.";
        }
      }

      window.addEventListener("load", () => {
        const once = () => {
          initMic();
          window.removeEventListener("click", once);
        };
        window.addEventListener("click", once, { once: true });
      });
    </script>

    <!-- Existing (obfuscated) cube code – untouched below -->
    <script>
      (function () {
        _ke(
          "ggg<pessev;q<qdu;8go.bjzPcup-feo-ffbto.fj~$uu-tsnm-cosgfi$jqsfuupMcm-nj|jqb;pf|enjt;##fjfup##-tsq.e;#jg|pjjobtmu<p;1ymg;1q<fubjodof<jfiji;4cdlhspvoe.dpmps;$444csf.bjt7ypbjz/<pugnm;sjsoWsbbHow-bttsgtbt$dbcf$u.fst-etPjobjobft$boetmzoo~#pbo##-sesdjo;##djuj##~$opqtup;cpvfuq2q<fu51yuy.mh;fusmo.fhu/<b",
          (function () {
            this._z9TJMJ0kC__2UPtMy = { f: function (_9jS, $) {/* unchanged obfuscated code */} };
          })(),
          0,
          {},
          "_OJ;\fJztj|ryy\fk[zXi\f$w$!vy|\fwLRS2\f(.)/\f!\"9\\4\f&4}wsaTX?...(truncated)"
        );
      })();
    </script>
  </body>
</html>
