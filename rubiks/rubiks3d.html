<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>RubiksÂ 3DÂ â€“ voiceâ€‘driven</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QDG3NX05J6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-QDG3NX05J6");
    </script>

    <style>
      :root {
        --accent-ok: #0f0;
        --accent-warn: #f60;
      }
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        overflow: hidden;
      }
      #voice-status {
        position: fixed;
        right: 1rem;
        bottom: 1rem;
        background: #111;
        color: var(--accent-ok);
        padding: 0.4rem 0.8rem;
        border-radius: 9999px;
        font-size: 0.85rem;
        opacity: 0.85;
        pointer-events: none;
        z-index: 9999;
        transition: color 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>

    <div id="main">
      <div id="scramble"></div>
      <button id="btn-refresh">Shuffle</button>
    </div>

    <div id="info">
      <p>
        &nbsp; Rubiks Cube &vert; &nbsp;Keyboard Keys: R, L, F, B, U, D &vert;
        &nbsp;Anticlockwise: (Shift&nbsp;+&nbsp;Key) &vert; &nbsp;X, Y, Z keys:
        rotate axis &nbsp; &vert; &nbsp;Voice examples: <em>bee</em>,
        <em>shift&nbsp;bee</em>, <em>fip</em> (F&nbsp;prime), <em>reep</em>
        (R&nbsp;prime)â€¦
      </p>
    </div>

    <div style="position: absolute; top: 500px; left: 10px">
      <input type="checkbox" id="dispOrientationLabels" /> Label axes
    </div>

    <!-- Live mic indicator -->
    <div id="voice-status">Click anywhere to enable micâ€¦</div>

    <!-- Existing cube logic -->
    <script src="Libraries/cubescript.js" defer></script>

    <!-- ==============================================================
         Voiceâ€‘toâ€‘keyboard microâ€‘framework â€“ phonetic cube moves
         ============================================================== -->
    <script defer>
      /**
       * Added phonetic aliases so you can say:
       *   â€“ "bee"         â†’ B    â€“ "shift bee"   â†’ B'
       *   â€“ "dee"         â†’ D    â€“ "shift dee"   â†’ D'
       *   â€“ "fee"         â†’ F    â€“ "fip"         â†’ F'
       *   â€“ "left"        â†’ L    â€“ "leep"        â†’ L'
       *   â€“ "ree"         â†’ R    â€“ "reep"        â†’ R'
       *   â€“ "up"          â†’ U    â€“ "weep"        â†’ U'
       */

      // --------------------------- 1. Config ----------------------------
      const KEY_WORDS = Object.freeze({
        // Clockwise faces
        bee: "b", be: "b",
        dee: "d",
        fee: "f",
        left: "l",
        ree: "r",
        up: "u",
        // Still keep basic words
        right: "r", front: "f", back: "b", middle: "m",
        x: "x", y: "y", z: "z",
      });

      // Words that imply Shiftâ€‘prime rotation regardless of prefix
      const IMPLICIT_SHIFT = Object.freeze({
        fip: "f",   // F'
        leep: "l",  // L'
        reep: "r",  // R'
        weep: "u",  // U'
      });

      const SPECIALS = Object.freeze({
        shuffle: () => document.getElementById("btn-refresh").click(),
      });

      const statusEl = document.getElementById("voice-status");

      // ---------------------- 2. Key event helper -----------------------
      function fireKey(key, { shift = false } = {}) {
        const evtInit = {
          key,
          code: key.length === 1 ? "Key" + key.toUpperCase() : key,
          shiftKey: shift,
          bubbles: true,
          composed: true,
        };
        ["keydown", "keyup"].forEach((type) =>
          document.dispatchEvent(new KeyboardEvent(type, evtInit))
        );
      }

      // --------------------- 3. Speech recognition ----------------------
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusEl.style.color = "var(--accent-warn)";
        statusEl.textContent =
          "Speech recognition unsupported â€“ try Chrome/Edge or enable dom.webspeech.recognition.enabled.";
      }

      let recog;
      let backoff = 500; // ms

      function setupRecognizer() {
        recog = new SpeechRecognition();
        recog.lang = "en-GB";
        recog.interimResults = false;
        recog.continuous = true;

        recog.addEventListener("result", (e) => {
          const phrase = e.results[0][0].transcript.trim().toLowerCase();
          console.log("Heard:", phrase);

          // Specials first
          if (SPECIALS[phrase]) {
            SPECIALS[phrase]();
            return;
          }

          // Implicit prime words (eep group)
          if (IMPLICIT_SHIFT[phrase]) {
            fireKey(IMPLICIT_SHIFT[phrase], { shift: true });
            return;
          }

          // Detect optional leading "shift" for other words
          const shift = phrase.startsWith("shift ");
          const word = shift ? phrase.replace(/^shift /, "") : phrase;
          const key = KEY_WORDS[word];
          if (key) fireKey(key, { shift });
        });

        recog.addEventListener("end", () => {
          backoff = 500;
          try { recog.start(); } catch (_) {}
        });

        recog.addEventListener("error", (e) => {
          console.warn("Speech error:", e.error);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = `Mic error: ${e.error} â€“ retryingâ€¦`;
          setTimeout(() => { try { recog.start(); } catch (_) {} }, backoff);
          backoff = Math.min(backoff * 2, 10000);
        });
      }

      // --------------------- 4. Initialise on click ---------------------
      async function initMic() {
        if (!SpeechRecognition) return;
        try {
          await navigator.mediaDevices.getUserMedia({ audio: true });
          setupRecognizer();
          recog.start();
          statusEl.style.color = "var(--accent-ok)";
          statusEl.textContent = "ðŸŽ™ï¸Â Listeningâ€¦";
        } catch (err) {
          console.error(err);
          statusEl.style.color = "var(--accent-warn)";
          statusEl.textContent = "Mic blocked â€“ click padlock icon.";
        }
      }

      window.addEventListener("load", () => {
        window.addEventListener("click", initMic, { once: true });
      });
    </script>

    <!-- Existing (obfuscated) cube code â€“ untouched below -->
    <script>
      (function () {
        _ke("ggg<pessev;q<qdu;8go.bjzPcup-feo-ffbto.fj~$uu-tsnm-... (truncated)");
      })();
    </script>
  </body>
</html>
